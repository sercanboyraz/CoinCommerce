"use strict";function shippingAddressContext(o,u,e,s,l,t,n){var p,i={init:function(e){if((p=e.shippingAddresses).selectedShippingAddress={},p.selectedShippingAddress.country={},p.selectedShippingAddress.stateProvince={},p.addresses&&0<p.addresses.length){for(var t=0;t<p.addresses.length;t++)p.addresses[t].availableCountries=angular.copy(p.availableCountries),p.addresses[t].availableStates=angular.copy(p.availableStatesForNoCountry);var s=p.shippingAddress;if(angular.isDefined(s)){s.availableCountries=angular.copy(p.availableCountries);var n=$.grep(p.addresses,function(e){return e.id===s.id});if(0<n.length){var i=n[0];i.availableStates=angular.copy(s.availableStates)}p.selectedShippingAddress=s}else s=angular.copy(p.addresses[0]),!e.configuration.shipToSameAddress&&p.settings.countryEnabled&&e.configuration.defaultShippingCountryId&&(p.selectedShippingAddress.country.value=e.configuration.defaultShippingCountryId.toString()),e.configuration.shipToSameAddress&&p.settings.countryEnabled&&e.configuration.defaultBillingCountryId&&(p.selectedShippingAddress.country.value=e.configuration.defaultBillingCountryId.toString()),s.availableStates=p.availableStates;p.settings.countryEnabled&&(p.countries=s.availableCountries),p.settings.stateProvinceEnabled&&(p.states=s.availableStates),p.selectedShippingAddress.customAddressAttributes=s.customAddressAttributes,l.equalize(s,p.addresses)}c.setState(p)},get:function(){return p},set:function(i){if(p&&p.selectedShippingAddress){var a,e={},r=angular.copy(p.selectedShippingAddress);angular.copy(i,p.selectedShippingAddress);for(var t=0;t<p.persistedShippingAddressFields.length;t++){var s=p.persistedShippingAddressFields[t];if("CountryId"!==s)if("StateProvinceId"!==s){var n=l.uncapitalizeFirstLetter(p.persistedShippingAddressFields[t]);i[n]!==r[n]&&(e["new"+s]=i[n],a||(a={}),a["update"+s]=v(s,i[n]))}else i.stateProvince.value!==r.stateProvince.value&&(e.newStateProvinceId=i.stateProvince.value,a||(a={}),a.updateStateProvince=v("StateProvinceId",i.stateProvince.value));else if(i.country.value!==r.country.value){var d=i.country.value;d&&0!==d.length||(p.states=angular.copy(i.availableStates),d=0),e.newCountryId=d,a||(a={}),a.updateCountry=g(d)}}angular.isDefined(a)&&o.$broadcast("shippingContextChanging",e),u.all(a).then(function(){for(var e={},t=0;t<p.persistedShippingAddressFields.length;t++){var s=p.persistedShippingAddressFields[t];if("CountryId"!==s)if("StateProvinceId"!==s){var n=l.uncapitalizeFirstLetter(p.persistedShippingAddressFields[t]);i[n]!==r[n]&&(e["new"+s]=i[n])}else i.stateProvince.value!==r.stateProvince.value&&(e.newStateProvinceId=i.stateProvince.value);else i.country.value!==r.country.value&&(e.newCountryId=i.country.value)}angular.isDefined(a)&&o.$broadcast("shippingContextChanged",e),c.setState(p)},function(e){return p=c.getLastState(),o.$broadcast("shippingContextChanged"),u.reject(e)})}}},c=t.instance();function g(t){return s.updateCountry(t,"Shipping").then(function(){t=parseInt(t);var e={};return p.settings.stateProvinceEnabled&&(e.states=s.getStatesByCountryId(t)),u.all(e).then(function(e){if(p.settings.stateProvinceEnabled){var t;p.states=e.states.data;var s=p.selectedShippingAddress.stateProvince.value;s!=c.getLastState().selectedShippingAddress.stateProvince.value?t=s:(t=0,p.selectedShippingAddress.stateProvince={}),v("StateProvinceId",t),n(function(){$(document).trigger({type:"addressStatesUpdated",statesDropdownId:"#shippingStateProvince"})},100)}return c.setState(p),e},function(e){return p=c.getLastState(),u.reject(e)})},function(e){return p=c.getLastState(),u.reject(e)})}function v(e,t){return s.updateAddress(e,t,"shipping").then(function(e){return e},function(e){return u.reject(e)})}return i}angular.module("realOnePageCheckout.shippingAddress").factory("shippingAddressContext",shippingAddressContext),shippingAddressContext.$inject=["$rootScope","$q","api","shippingAddressService","objectUtility","stateHolder","$timeout"];